<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RPub - RSS to EPUB</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div id="login-overlay" class="hidden">
        <div id="login-box">
            <h2>Login Required</h2>
            <form id="login-form">
                <input type="text" id="username" placeholder="Username" required />
                <input type="password" id="password" placeholder="Password" required />
                <button type="submit">Login</button>
            </form>
            <p id="login-error" style="color: var(--danger)"></p>
        </div>
    </div>
    <div class="container hidden">
        <header>
            <div class="header-content">
                <h1>RPub</h1>
                <p>RSS Aggregator & EPUB Generator</p>
            </div>
            <div class="header-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path>
                </svg>
            </div>
        </header>

        <main class="dashboard-grid">
            <div class="column">

                <section id="feeds-section" class="card">
                    <h2>Feeds</h2>
                    <ul id="feeds-list" class="item-list"></ul>
                    <form id="add-feed-form">
                        <div class="input-group">
                            <input type="url" name="url" placeholder="Feed URL" required />
                            <input type="text" name="name" placeholder="Name (Optional)" />
                        </div>
                        <div class="input-group">
                            <input type="number" name="concurrency_limit" placeholder="Limit (0=Unl)" min="0" />
                            <button type="submit" class="add-btn">Add Feed</button>
                        </div>
                    </form>
                </section>
            </div>

            <div class="column">

                <section id="generate-section" class="card">
                    <h2>Manual Generation</h2>
                    <button id="generate-btn">Generate EPUB Now</button>
                    <div id="status"></div>
                </section>


                <section id="schedules-section" class="card">
                    <h2>Schedules</h2>
                    <ul id="schedules-list" class="item-list"></ul>
                    <form id="add-schedule-form">
                        <div class="time-row">
                            <select name="hour" required>
                                <option value="" disabled selected>Hour</option>
                                <script>
                                    for (let i = 0; i < 24; i++) {
                                        const val = i.toString().padStart(2, '0');
                                        document.write(`<option value="${val}">${val}</option>`);
                                    }
                                </script>
                            </select>
                            <span>:</span>
                            <select name="minute" required>
                                <option value="" disabled selected>Min</option>
                                <script>
                                    for (let i = 0; i < 60; i += 5) {
                                        const val = i.toString().padStart(2, '0');
                                        document.write(`<option value="${val}">${val}</option>`);
                                    }
                                </script>
                            </select>
                            <select name="timezone" id="timezone-select" required>
                                <option value="" disabled selected>Timezone</option>
                            </select>
                        </div>
                        <button type="submit" class="add-btn">Add Schedule</button>
                    </form>
                    <p class="hint">
                        Selected time will be converted to GMT for the scheduler.
                    </p>
                </section>


                <section id="cover-section" class="card">
                    <h2>Cover Image</h2>
                    <div class="cover-wrapper">
                        <div class="current-cover">

                            <img id="cover-preview" src="/cover.jpg" alt="Book Cover" />
                        </div>
                        <div class="upload-cover">
                            <h3>Replace Cover</h3>
                            <form id="upload-cover-form">
                                <input type="file" id="cover-file" name="cover" accept="image/jpeg" required />
                                <button type="submit" class="add-btn">Upload New Cover</button>
                            </form>
                            <div id="upload-status"></div>
                        </div>
                    </div>
                </section>


                <section id="downloads-section" class="card">
                    <h2>Downloads</h2>
                    <ul id="downloads-list" class="item-list"></ul>
                </section>
            </div>
        </main>
    </div>

    <script>
        let authHeader = localStorage.getItem("rpub_auth");


        const timezoneSelect = document.getElementById('timezone-select');
        const timezones = Intl.supportedValuesOf('timeZone');
        timezones.forEach(tz => {
            const opt = document.createElement('option');
            opt.value = tz;
            opt.textContent = tz;
            if (tz === Intl.DateTimeFormat().resolvedOptions().timeZone) {
                opt.selected = true;
            }
            timezoneSelect.appendChild(opt);
        });


        async function api(url, method = "GET", body = null) {
            const headers = { "Content-Type": "application/json" };
            if (authHeader) {
                headers["Authorization"] = authHeader;
            }

            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);

            const res = await fetch(url, options);

            if (res.status === 401) {
                showLogin();
                throw new Error("Unauthorized");
            }

            if (!res.ok) throw new Error(await res.text());
            return res.json().catch(() => { });
        }

        function showLogin() {
            document
                .getElementById("login-overlay")
                .classList.remove("hidden");

            const container = document.querySelector(".container");
            container.classList.remove("hidden");
            container.classList.add("blur-content");
        }

        function hideLogin() {
            document
                .getElementById("login-overlay")
                .classList.add("hidden");
            const container = document.querySelector(".container");
            container.classList.remove("blur-content");
            container.classList.remove("hidden");
        }

        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById("username").value;
            const p = document.getElementById("password").value;
            const creds = "Basic " + btoa(u + ":" + p);

            try {

                const res = await fetch("/auth/check", {
                    headers: { Authorization: creds },
                });

                if (res.ok) {
                    authHeader = creds;
                    localStorage.setItem("rpub_auth", creds);
                    hideLogin();

                    loadFeeds();
                    loadSchedules();
                    loadDownloads();
                } else {
                    document.getElementById("login-error").textContent =
                        "Invalid credentials";
                }
            } catch (err) {
                document.getElementById("login-error").textContent =
                    "Login failed";
            }
        }


        async function loadFeeds() {
            try {
                const feeds = await api("/feeds");
                const list = document.getElementById("feeds-list");
                list.innerHTML = feeds
                    .map(
                        (f) => `
                    <li>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="rss-icon" style="color: var(--accent-blue); flex-shrink: 0;"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
                            <span>${f.name || f.url} <small>(${f.concurrency_limit === 0 ? "Unlimited" : f.concurrency_limit + " threads"})</small></span>
                        </div>
                        <button onclick="deleteFeed(${f.id})" class="delete-btn">×</button>
                    </li>
                `,
                    )
                    .join("");
            } catch (e) {
                console.error(e);
            }
        }

        async function addFeed(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            await api("/feeds", "POST", {
                url: formData.get("url"),
                name: formData.get("name") || null,
                concurrency_limit: parseInt(
                    formData.get("concurrency_limit") || "0",
                    10,
                ),
            });
            e.target.reset();
            loadFeeds();
        }

        async function deleteFeed(id) {
            if (confirm("Delete this feed?")) {
                await api(`/feeds/${id}`, "DELETE");
                loadFeeds();
            }
        }


        async function loadSchedules() {
            try {
                const schedules = await api("/schedules");
                const list = document.getElementById("schedules-list");

                function formatCron(cron) {
                    try {
                        const parts = cron.split(' ');

                        if (parts.length >= 5 && parts[0] === '0' && parts[3] === '*' && parts[4] === '*' && parts[5] === '*') {
                            const minute = parseInt(parts[1], 10);
                            const hour = parseInt(parts[2], 10);


                            const date = new Date();
                            date.setUTCHours(hour, minute, 0, 0);


                            return new Intl.DateTimeFormat('default', {
                                hour: 'numeric',
                                minute: 'numeric',
                                timeZoneName: 'short'
                            }).format(date);
                        }
                    } catch (e) {
                        console.error("Error parsing cron", e);
                    }
                    return cron;
                }

                list.innerHTML = schedules
                    .map(
                        (s) => `
                    <li>
                        <span>${formatCron(s.cron_expression)}</span>
                        <button onclick="deleteSchedule(${s.id})" class="delete-btn">×</button>
                    </li>
                `,
                    )
                    .join("");
            } catch (e) {
                console.error(e);
            }
        }

        async function addSchedule(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            const hour = parseInt(formData.get("hour"), 10);
            const minute = parseInt(formData.get("minute"), 10);
            const timezone = formData.get("timezone");

            if (isNaN(hour) || isNaN(minute) || !timezone) {
                alert("Please select Hour, Minute, and Timezone.");
                return;
            }




            const now = new Date();







            const targetHour = hour;
            const targetMinute = minute;


            let guess = new Date();
            guess.setUTCHours(targetHour, targetMinute, 0, 0);


            function getTimeInZone(date, zone) {
                const parts = new Intl.DateTimeFormat('en-US', {
                    timeZone: zone,
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: false
                }).formatToParts(date);

                const h = parseInt(parts.find(p => p.type === 'hour').value, 10);
                const m = parseInt(parts.find(p => p.type === 'minute').value, 10);

                return { h: h === 24 ? 0 : h, m };
            }


            for (let i = 0; i < 3; i++) {
                const currentInZone = getTimeInZone(guess, timezone);

                let diffMinutes = (targetHour - currentInZone.h) * 60 + (targetMinute - currentInZone.m);


                if (diffMinutes > 720) diffMinutes -= 1440;
                if (diffMinutes < -720) diffMinutes += 1440;

                if (diffMinutes === 0) break;

                guess.setTime(guess.getTime() + diffMinutes * 60 * 1000);
            }


            const utcHour = guess.getUTCHours();
            const utcMinute = guess.getUTCMinutes();

            const cronExpression = `0 ${utcMinute} ${utcHour} * * *`;

            await api("/schedules", "POST", {
                cron_expression: cronExpression,
            });



            loadSchedules();
        }

        async function deleteSchedule(id) {
            if (confirm("Delete this schedule?")) {
                await api(`/schedules/${id}`, "DELETE");
                loadSchedules();
            }
        }


        async function loadDownloads() {
            try {
                const files = await api("/downloads");
                const list = document.getElementById("downloads-list");
                list.innerHTML = files
                    .map(
                        (f) => `
                    <li>
                        <a href="/epubs/${f}" download>${f}</a>
                    </li>
                `,
                    )
                    .join("");
            } catch (e) {
                console.error(e);
            }
        }


        async function generate() {
            const btn = document.getElementById("generate-btn");
            const status = document.getElementById("status");
            btn.disabled = true;
            status.textContent = "Requesting generation...";

            try {
                const res = await fetch("/generate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        ...(authHeader
                            ? { Authorization: authHeader }
                            : {}),
                    },
                    body: JSON.stringify({ feeds: [] }),
                });

                if (res.ok) {
                    status.textContent =
                        "Generation started in background. Please wait...";

                    let checks = 0;
                    const interval = setInterval(async () => {
                        checks++;
                        await loadDownloads();
                        if (checks > 10) {

                            clearInterval(interval);
                            status.textContent =
                                "Generation started. Check downloads list below.";
                        }
                    }, 2000);
                } else if (res.status === 401) {
                    showLogin();
                    status.textContent = "Authentication required.";
                } else {
                    status.textContent = "Error: " + (await res.text());
                }
            } catch (e) {
                status.textContent = "Error: " + e.message;
            } finally {
                btn.disabled = false;
            }
        }

        async function uploadCover(e) {
            e.preventDefault();
            const form = e.target;
            const status = document.getElementById("upload-status");
            const fileInput = document.getElementById("cover-file");

            if (fileInput.files.length === 0) return;

            const formData = new FormData();
            formData.append("cover", fileInput.files[0]);

            status.textContent = "Uploading...";

            try {

                const headers = {};
                if (authHeader) headers["Authorization"] = authHeader;


                const res = await fetch("/cover", {
                    method: "POST",
                    headers: headers,
                    body: formData,
                });

                if (res.ok) {
                    status.textContent = "Cover updated successfully!";
                    status.style.color = "var(--accent-green)";

                    document.getElementById("cover-preview").src =
                        "/cover.jpg?t=" + new Date().getTime();
                    form.reset();
                } else if (res.status === 401) {
                    showLogin();
                    status.textContent = "Authentication required.";
                    status.style.color = "var(--danger)";
                } else {
                    status.textContent = "Error: " + (await res.text());
                    status.style.color = "var(--danger)";
                }
            } catch (err) {
                status.textContent = "Error: " + err.message;
                status.style.color = "var(--danger)";
            }
        }


        async function checkAuth() {
            try {
                await api("/auth/check");

                document
                    .querySelector(".container")
                    .classList.remove("hidden");
                loadFeeds();
                loadSchedules();
                loadDownloads();
            } catch (e) {

            }
        }


        document
            .getElementById("login-form")
            .addEventListener("submit", handleLogin);
        document
            .getElementById("add-feed-form")
            .addEventListener("submit", addFeed);
        document
            .getElementById("add-schedule-form")
            .addEventListener("submit", addSchedule);
        document
            .getElementById("add-schedule-form")
            .addEventListener("submit", addSchedule);
        document
            .getElementById("generate-btn")
            .addEventListener("click", generate);
        document
            .getElementById("upload-cover-form")
            .addEventListener("submit", uploadCover);

        checkAuth();
    </script>
</body>

</html>